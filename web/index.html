<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AI Manuals Helper</title>
<style>
 body {font-family: sans-serif; max-width: 720px; margin: 40px auto;}
 input[type=file], input[type=text] {padding: 4px; font-size: 1em;}
 button {padding: 6px 10px; margin-left: 4px;}
 pre {white-space: pre-wrap; background:#f5f5f5; padding:12px;}

 /* tiny bars in summary table */
 table#fb td {min-width: 60px;}
</style>
</head><body>

<h2>AI Manuals Helper</h2>

<!---------------------------- 1.  Upload ----------------------------------->
<h4>Upload a PDF</h4>
<input type="file" id="pdf">
<button onclick="upload()">Upload</button>

<!---------------------------- 2.  Ask -------------------------------------->
<h4 style="margin-top:32px;">Ask a question</h4>
<input id="q" size="60" placeholder="Type your question…">
<button onclick="ask()">Ask</button>

<pre id="a"></pre>
<div id="fbBtns" style="display:none;">
  Helpful?
  <button onclick="sendFeedback(1)">👍</button>
  <button onclick="sendFeedback(-1)">👎</button>
</div>

<hr>

<!---------------------------- 3.  Feedback summary ------------------------->
<h4>📈 Feedback (last 7 days)</h4>
<table id="fb" border="1" cellpadding="4">
  <tr><th>Date</th><th>👍</th><th>👎</th></tr>
</table>

<script>
let lastQuestion = "", lastAnswer = "", currentCustomer = "demo01";

/* --------  upload  -------- */
async function upload(){
  if(!pdf.files[0]) {alert("Choose a PDF first"); return;}
  const fd = new FormData();
  fd.append("file", pdf.files[0]);
  fd.append("customer", currentCustomer);
  const r = await fetch("/upload", {method:"POST", body:fd});
  const j = await r.json();
  alert("Uploaded “"+j.file+"” and queued for ingestion");
}

/* --------  ask  -------- */
async function ask(){
  if(!q.value.trim()){ alert("Type a question"); return; }
  const fd = new FormData();
  fd.append("question", q.value);
  fd.append("customer", currentCustomer);

  a.textContent = "⏳ Thinking…";
  const r = await fetch("/chat", {method:"POST", body:fd});
  const j = await r.json();

  lastQuestion = q.value;
  lastAnswer   = j.answer;
  a.textContent = lastAnswer;
  fbBtns.style.display = "inline";
}

/* --------  feedback buttons  -------- */
async function sendFeedback(score){
  await fetch("/feedback", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      customer: currentCustomer,
      question: lastQuestion,
      answer:   lastAnswer,
      score:    score
    })
  });
  fbBtns.style.display = "none";
  loadFeedback();          // refresh summary
}

/* --------  load summary table  -------- */
async function loadFeedback(days=7){
  const res = await fetch(`/feedback/summary?days=${days}`);
  if(!res.ok){ console.error("feedback fetch failed"); return; }
  const data = await res.json();

  const tbl = document.getElementById("fb");
  while(tbl.rows.length > 1) tbl.deleteRow(1);      // clear old rows

  for(const r of data){
    const row = tbl.insertRow();
    row.insertCell().textContent = r.day;
    row.insertCell().textContent = r.up;
    row.insertCell().textContent = r.down;

    /* mini-bars */
    const max = Math.max(r.up, r.down, 1);
    row.cells[1].style.background =
      `linear-gradient(to right,#4caf50 ${r.up/max*100}%,transparent 0)`;
    row.cells[2].style.background =
      `linear-gradient(to right,#f44336 ${r.down/max*100}%,transparent 0)`;
  }
}
loadFeedback();    // run once at page load
</script>
</body></html>
