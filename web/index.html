<!-- START OF UPDATED index.html WITH FEEDBACK -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI-Manuals demo</title>
  <style>
    body {font-family:sans-serif;max-width:680px;margin:auto;padding:20px}
    #answer{white-space:pre-wrap;border:1px solid #ccc;padding:12px;margin-top:12px}
    .fb {font-size:20px;margin:0 6px;cursor:pointer}
    .hide{display:none}
    #status{margin-top:10px;font-size:14px;color:#555}
  </style>
  <meta name="api-key" content="abc123demo">
</head>
<body>
  <h2>Manual helper</h2>

  <h4>Upload a PDF</h4>
  <input type="file" id="pdf" />
  <button id="uploadBtn">Upload</button>
  <div id="status"></div>

  <h4>Ask a question</h4>
  <input id="q" size="60" placeholder="Type your question‚Ä¶" disabled />
  <button onclick="ask()" id="askBtn" disabled>Ask</button><br><br>

  <div id="answer"></div>
  <div id="fb" class="hide">
    <span class="fb" onclick="sendFeedback(1)">üëç</span>
    <span class="fb" onclick="sendFeedback(-1)">üëé</span>
  </div>

<script>
const pdf       = document.getElementById('pdf');
const uploadBtn = document.getElementById('uploadBtn');
const q         = document.getElementById('q');
const askBtn    = document.getElementById('askBtn');
const statusEl  = document.getElementById('status');
const answerEl  = document.getElementById('answer');
const fbDiv     = document.getElementById('fb');

const API_KEY = document.querySelector('meta[name="api-key"]').content || "";
const headers = extra => ({ 'X-API-Key': API_KEY, ...extra });

let DOC_ID = "";
let USER_DOC_TYPE = "";
let pollTimer, uploading = false;

let lastQuestion = "";
let lastAnswer = "";
let lastChunks  = [];

uploadBtn.onclick = () => {
  if (uploading) return;
  const file = pdf.files[0];
  if (!file) {
    alert("Please choose a PDF first.");
    return;
  }

  uploading = true;
  statusEl.textContent = "Uploading‚Ä¶";
  pdf.disabled = true;
  uploadBtn.disabled = true;

  const fd = new FormData();
  fd.append("file", file);

  fetch("/upload", { method: "POST", headers: headers(), body: fd })
    .then(r => r.json())
    .then(js => {
      if (!js.doc_id) throw new Error("No doc_id returned.");
      DOC_ID = js.doc_id;

      showMetaForm();

      if (js.status === "duplicate") {
        statusEl.textContent = "‚úÖ Manual already uploaded ‚Äî ready to ask.";
        q.disabled = false;
        askBtn.disabled = false;
        uploading = false;
        return;
      }

      pollTimer = setInterval(checkReady, 2000);
    })
    .catch(err => {
      console.error(err);
      statusEl.textContent = "‚ùå Upload failed.";
      uploading = false;
      pdf.disabled = false;
      uploadBtn.disabled = false;
    });
};

async function checkReady() {
  if (!DOC_ID) return;

  const job = await fetch(`/ingest/status?doc_id=${DOC_ID}`, { headers: headers() }).then(r => r.json());
  statusEl.textContent = `Embedded ${job.done}/${job.total} chunks‚Ä¶`;

  if (job.ready) {
    clearInterval(pollTimer);
    uploading = false;
    statusEl.textContent = "‚úÖ Ready ‚Äì press Ask";
    q.disabled = false;
    askBtn.disabled = false;
  }
}

function showMetaForm() {
  if (document.getElementById("metaForm")) return;
  const html = `
    <div id="metaForm">
      <hr><b>What type of manual?</b><br>
      <label><input type="radio" name="dt" value="software" checked> Software</label>
      <label><input type="radio" name="dt" value="hardware"> Physical product</label>
      <label><input type="radio" name="dt" value="service"> Service</label><br>
      Notes: <input id="notes" size="40" placeholder="e.g. CNC mill">
      <button id="saveMeta">Save</button> <span id="metaStatus"></span>
    </div>`;
  statusEl.insertAdjacentHTML("afterend", html);
  document.getElementById("saveMeta").onclick = saveMeta;
}

async function saveMeta() {
  if (!DOC_ID) {
    alert("No doc ID yet ‚Äî try reloading.");
    return;
  }

  USER_DOC_TYPE = document.querySelector('input[name="dt"]:checked').value;
  const notes = document.getElementById("notes").value;

  const fd = new FormData();
  fd.append("doc_id", DOC_ID);
  fd.append("doc_type", USER_DOC_TYPE);
  fd.append("notes", notes);

  await fetch("/upload/metadata", { method: "POST", headers: headers(), body: fd });
  document.getElementById("metaStatus").textContent = "‚úîÔ∏è saved";
}

async function ask() {
  if (!DOC_ID || !q.value.trim()) return;
  askBtn.disabled = true;
  answerEl.textContent = "Thinking‚Ä¶";
  fbDiv.classList.add("hide");

  const fd = new FormData();
  fd.append("question", q.value);
  fd.append("doc_type", USER_DOC_TYPE);
  fd.append("doc_id", DOC_ID);

  const js = await fetch("/chat", { method: "POST", headers: headers(), body: fd }).then(r => r.json());

  answerEl.textContent = js.answer;
  askBtn.disabled = false;
  fbDiv.classList.remove("hide");

  lastQuestion = q.value;
  lastAnswer   = js.answer || "";
  lastChunks   = js.chunks_used || [];
}

async function sendFeedback(good) {
  const body = {
    doc_id:   DOC_ID,
    question: lastQuestion,
    answer:   lastAnswer,
    chunks:   lastChunks.join(","),
    good:     good > 0,
  };

  await fetch("/feedback", {
    method: "POST",
    headers: headers({ "Content-Type": "application/json" }),
    body: JSON.stringify(body),
  });

  fbDiv.classList.add("hide");
  console.log("Feedback sent:", good > 0 ? "üëç" : "üëé");
}
</script>

<hr>
<h4>QA Health (last 30 days)</h4>
<canvas id="qaChart" height="120"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script>
async function drawChart() {
  const data = await fetch("/metrics", { headers: headers() }).then(r => r.json());
  if (!data.records || !data.records.length) return;

  const labels = data.records.map(d => d.timestamp.slice(5));
  const chunks = data.records.map(d => d.count);
  const conf   = data.records.map(d => d.avg_conf.toFixed(2));

  new Chart(document.getElementById("qaChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "avg chunks", data: chunks },
        { label: "avg conf", data: conf, type: "line", yAxisID: "y1" }
      ]
    },
    options: {
      scales: {
        y: { beginAtZero: true },
        y1: { position: "right", min: 0, max: 1 }
      }
    }
  });
}
drawChart();
</script>
</body>
</html>
<!-- END OF UPDATED index.html WITH FEEDBACK -->
