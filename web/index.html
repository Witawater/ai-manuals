<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI-Manuals demo</title>
  <style>
    body {font-family:sans-serif;max-width:680px;margin:auto;padding:20px}
    #answer{white-space:pre-wrap;border:1px solid #ccc;padding:12px;margin-top:12px}
    .fb {font-size:20px;margin:0 6px;cursor:pointer}
    .hide{display:none}
    #status{margin-top:10px;font-size:14px;color:#555}
  </style>
  <!-- FIXME: inject your real API key value below or via build-step -->
  <meta name="api-key" content="d4d6aa9f2bf75faf76454d8621af7c01">
</head>
<body>
  <h2>Manual helper</h2>

  <h4>Upload a PDF</h4>
  <input type="file" id="pdf" />
  <button onclick="upload()">Upload</button>
  <div id="status"></div>

  <h4>Ask a question</h4>
  <input id="q" size="60" placeholder="Type your questionâ€¦" disabled />
  <button onclick="ask()" id="askBtn" disabled>Ask</button><br><br>

  <div id="answer"></div>

  <!-- feedback bar (unchanged) -->
  <div id="fb" class="hide">
    <span class="fb" onclick="sendFeedback(1)">ğŸ‘</span>
    <span class="fb" onclick="sendFeedback(-1)">ğŸ‘</span>
  </div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pdf      = document.getElementById('pdf');
const nextBtn  = document.querySelector('button');          // the old â€œUploadâ€ btn
const q        = document.getElementById('q');
const askBtn   = document.getElementById('askBtn');
const statusEl = document.getElementById('status');
const answerEl = document.getElementById('answer');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_KEY   = document.querySelector('meta[name="api-key"]').content || "";
const headers   = extra => ({ 'X-API-Key': API_KEY, ...extra });
let DOC_ID      = "";
let USER_DOC_TYPE = "";
let pollTimer, uploading = false;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1) auto-upload on file pick â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pdf.onchange = () => {
  if(uploading) return;
  const file = pdf.files[0];
  if(!file){ return; }

  uploading = true;
  statusEl.textContent = 'Waitingâ€¦ (Press Upload)';
  pdf.disabled = true;

  const fd = new FormData(); fd.append('file', file);

  fetch('/upload', {method:'POST', headers: headers(), body: fd})
    .then(r => r.json())
    .then(js => {
      DOC_ID = js.doc_id;
      pollTimer = setInterval(checkReady, 2000);
    })
    .catch(err => {
      statusEl.textContent = 'âŒ upload failed';
      alert(err);
    });
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2) â€œUpload / Nextâ€ button now only shows the form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
nextBtn.onclick = () => {
  if(document.getElementById('metaForm')) return;
  if(!pdf.files.length){ alert('First choose a PDF'); return; }
  showMetaForm();
  nextBtn.disabled = true;
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3) ingest status polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkReady(){
  const job = await fetch(`/ingest/status?doc_id=${DOC_ID}`, {headers: headers()}).then(r=>r.json());
  statusEl.textContent = `Embedded ${job.done}/${job.total} chunksâ€¦`;
  if(job.ready){
    clearInterval(pollTimer);
    uploading = false;
    statusEl.textContent = 'âœ… Ready â€“ press Ask';
    askBtn.disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4) metadata form & save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMetaForm(){
  const html = `
    <div id="metaForm">
      <hr><b>What type of manual?</b><br>
      <label><input type=radio name=dt value=software checked> Software</label>
      <label><input type=radio name=dt value=hardware> Physical product</label>
      <label><input type=radio name=dt value=service> Service</label><br>
      Notes: <input id=notes size=40 placeholder="e.g. CNC mill">
      <button id="saveMeta">Save</button> <span id="metaStatus"></span>
    </div>`;
  statusEl.insertAdjacentHTML('afterend', html);
  document.getElementById('saveMeta').onclick = saveMeta;
}

async function saveMeta(){
  USER_DOC_TYPE = document.querySelector('input[name=dt]:checked').value;
  const notes = document.getElementById('notes').value;
  const fd = new FormData();
  fd.append('doc_id', DOC_ID);
  fd.append('doc_type', USER_DOC_TYPE);
  fd.append('notes', notes);

  await fetch('/upload/metadata', {method:'POST', headers: headers(), body: fd});
  document.getElementById('metaStatus').textContent = 'âœ”ï¸ saved';
  q.disabled = false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5) ask flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function ask(){
  if(!q.value.trim()) return;
  askBtn.disabled = true; answerEl.textContent = 'Thinkingâ€¦';

  const fd = new FormData();
  fd.append('question', q.value);
  fd.append('doc_type', USER_DOC_TYPE);

  const js = await fetch('/chat', {method:'POST', headers: headers(), body: fd}).then(r=>r.json());
  answerEl.textContent = js.answer;
  askBtn.disabled = false;
}
</script>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6) QA Health chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<hr>
<h4>QA Health (last 30 days)</h4>
<canvas id="qaChart" height="120"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script>
async function drawChart(){
  const data = await fetch('/metrics', {headers: headers()}).then(r=>r.json());
  if(!data.length) return;

  const labels = data.map(d=>d.day.slice(5));          // MM-DD
  const chunks = data.map(d=>d.avg_chunks);
  const conf   = data.map(d=>d.avg_conf.toFixed(2));

  new Chart(document.getElementById('qaChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {label:'avg chunks', data:chunks},
        {label:'avg conf', data:conf, type:'line', yAxisID:'y1'}
      ]
    },
    options:{
      scales:{
        y:{beginAtZero:true},
        y1:{position:'right', min:0, max:1}
      }
    }
  });
}
drawChart();
</script>
</body>
</html>
