<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI‚ÄëManuals demo</title>
  <style>
    body {font-family:sans-serif;max-width:680px;margin:auto;padding:20px}
    #answer{white-space:pre-wrap;border:1px solid #ccc;padding:12px;margin-top:12px}
    .fb {font-size:20px;margin:0 6px;cursor:pointer}
    .hide{display:none}
    #status{margin-top:10px;font-size:14px;color:#555}
  </style>
  <!-- FIXME: inject your real API key value below or via build-step -->
  <meta name="api-key" content="d4d6aa9f2bf75faf76454d8621af7c01">
</head>
<body>
  <h2>Manual helper</h2>

  <h4>Upload a PDF</h4>
  <input type="file" id="pdf" />
  <button onclick="upload()">Upload</button>
  <div id="status"></div>

  <h4>Ask a question</h4>
  <input id="q" size="60" placeholder="Type your question‚Ä¶" disabled />
  <button onclick="ask()" id="askBtn" disabled>Ask</button><br><br>

  <div id="answer"></div>

  <!-- feedback bar (unchanged) -->
  <div id="fb" class="hide">
    <span class="fb" onclick="sendFeedback(1)">üëç</span>
    <span class="fb" onclick="sendFeedback(-1)">üëé</span>
  </div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DOM refs
const pdf      = document.getElementById('pdf');
const q        = document.getElementById('q');
const askBtn   = document.getElementById('askBtn');
const statusEl = document.getElementById('status');
const answerEl = document.getElementById('answer');

// API key ‚Üí headers
const API_KEY = document.querySelector('meta[name="api-key"]').content || "";
const headers = extra => ({ 'X-API-Key': API_KEY, ...extra });

let DOC_ID = "", pollTimer;

// start ingest immediately after file pick OR via Upload btn
pdf.onchange = () => upload();

async function upload(){
  const file = pdf.files[0];
  if(!file){ alert('Pick a PDF first'); return; }

  statusEl.textContent = 'Uploading‚Ä¶';
  q.disabled = askBtn.disabled = true;

  try {
    const fd = new FormData(); fd.append('file', file);
    const res = await fetch('/upload', { method:'POST', headers: headers(), body: fd });
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const js = await res.json();

    DOC_ID = js.doc_id;
    statusEl.textContent = 'Processing PDF‚Ä¶ fill the form meanwhile.';
    showMetaForm();
    pollTimer = setInterval(checkReady, 2000);
  } catch(err){
    statusEl.textContent = '‚ùå Upload failed.';
    alert('Upload failed: '+ err);
  }
}

async function checkReady(){
  try{
    const res = await fetch(`/ingest/status?doc_id=${DOC_ID}`, { headers: headers() });
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const job = await res.json();

    statusEl.textContent = `Embedded ${job.done}/${job.total} chunks‚Ä¶`;
    if(job.ready){
      clearInterval(pollTimer);
      statusEl.textContent = '‚úÖ Ready ‚Äì ask away!';
      q.disabled = askBtn.disabled = false;
    }
  }catch(err){
    clearInterval(pollTimer);
    statusEl.textContent = '‚ùå Status check failed.';
    alert('Status check failed: '+ err);
  }
}

function showMetaForm(){
  const html = `\n    <hr><b>What type of manual?</b><br>\n    <label><input type=radio name=dt value=software checked> Software</label>\n    <label><input type=radio name=dt value=hardware> Physical product</label>\n    <label><input type=radio name=dt value=service> Service</label><br>\n    Notes: <input id=notes size=40 placeholder="e.g. 3-axis CNC mill">\n    <button onclick=\"saveMeta()\">Save</button><div id="metaStatus"></div>`;
  statusEl.insertAdjacentHTML('afterend', html);
}

async function saveMeta(){
  const doc_type = document.querySelector('input[name=dt]:checked').value;
  const notes = document.getElementById('notes').value;
  const fd = new FormData();
  fd.append('doc_id', DOC_ID);
  fd.append('doc_type', doc_type);
  fd.append('notes', notes);

  try{
    const res = await fetch('/upload/metadata', { method:'POST', headers: headers(), body: fd });
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    document.getElementById('metaStatus').textContent = '‚úîÔ∏è saved';
  }catch(err){
    alert('Metadata save failed: '+ err);
  }
}

async function ask(){
  if(!q.value.trim()) return;
  askBtn.disabled = true; answerEl.textContent = 'Thinking‚Ä¶';

  const fd = new FormData(); fd.append('question', q.value);
  try{
    const res = await fetch('/chat', { method:'POST', headers: headers(), body: fd });
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const js = await res.json();
    answerEl.textContent = js.answer;
  }catch(err){
    answerEl.textContent = '‚ùå Request failed.';
    alert('Question failed: '+ err);
  }finally{
    askBtn.disabled = false;
  }
}
</script>
</body>
</html>
