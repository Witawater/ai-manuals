<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI‑Manuals demo</title>
  <style>
    body   {font-family:sans-serif;max-width:680px;margin:auto;padding:20px}
    #answer{white-space:pre-wrap;border:1px solid #ccc;padding:12px;margin-top:12px}
    .fb    {font-size:20px;margin:0 6px;cursor:pointer}
    .hide  {display:none}
    #status{margin-top:10px;font-size:14px;color:#555}
  </style>
  <!-- hard‑coded key for demo, replace in prod -->
  <meta name="api-key" content="d4d6aa9f2bf75faf76454d8621af7c01">
</head>
<body>
<h2>Manual helper</h2>

<h4>Upload a PDF</h4>
<input type="file" id="pdf" />
<button onclick="upload()">Upload</button>
<div id="status"></div>

<h4>Ask a question</h4>
<input id="q" size="60" placeholder="Type your question…" disabled />
<button onclick="ask()" id="askBtn" disabled>Ask</button><br /><br />

<div id="answer"></div>

<!-- feedback bar -->
<div id="fb" class="hide">
  <span class="fb" onclick="sendFeedback( 1)">👍</span>
  <span class="fb" onclick="sendFeedback(-1)">👎</span>
</div>

<p>
  <a href="/dashboard.html" target="_blank">📊 Feedback dashboard</a>
</p>

<script>
// ─────────────── GLOBALS & UTILS ───────────────
const API_KEY = document.querySelector('meta[name="api-key"]')?.content || "";
const headers = extra => ({ "X-API-Key": API_KEY, ...extra });

let DOC_ID = "", pollTimer;
let lastQuestion = "", lastAnswer = "", lastChunks = [];

// start ingest the moment a file is picked
pdf.onchange = () => upload();

// ─────────────── UPLOAD & INGEST ───────────────
async function upload () {
  const file = pdf.files[0];
  if (!file) return alert("Choose a PDF first!");
  if (!file.name.toLowerCase().endsWith(".pdf")) return alert("Please upload a valid PDF file.");

  // lock UI
  q.disabled = askBtn.disabled = true;
  status.textContent = "Uploading…";

  // send file
  const fd = new FormData();
  fd.append("file", file);

  try {
    const js = await fetch("/upload", {method:"POST", headers: headers(), body: fd}).then(r=>r.json());
    DOC_ID = js.doc_id;
    status.textContent = `Processing “${js.file}”… fill the form meanwhile.`;

    // render metadata form and poll for status
    showMetaForm();
    pollTimer = setInterval(checkReady, 2000);
  } catch (err) {
    status.textContent = "❌ Upload failed.";
    alert("Upload failed: " + err);
  }
}

// poll backend for ingest progress
async function checkReady(){
  try {
    const job = await fetch(`/ingest/status?doc_id=${DOC_ID}`, {headers: headers()}).then(r=>r.json());
    if(job.error){
      status.textContent = `❌ ${job.error}`;
      clearInterval(pollTimer);
      return;
    }
    status.textContent = `Embedded ${job.done}/${job.total} chunks…`;

    if(job.ready){
      clearInterval(pollTimer);
      status.textContent = "✅ Ready – ask away!";
      q.disabled = askBtn.disabled = false;
    }
  } catch(err){
    console.error(err);
  }
}

// ─────────────── METADATA FORM ───────────────
function showMetaForm(){
  const html = `
    <hr><b>What type of manual?</b><br>
    <label><input type=radio name=dt value=software checked> Software</label>
    <label><input type=radio name=dt value=hardware> Physical product</label>
    <label><input type=radio name=dt value=service> Service</label>
    <label><input type=radio name=dt value=other> Other</label><br>
    Notes: <input id=notes size=40 placeholder="e.g. 3‑axis CNC mill">
    <button onclick="saveMeta()">Save</button>
    <div id="metaStatus"></div>`;
  status.insertAdjacentHTML("afterend", html);
}

async function saveMeta(){
  const doc_type = document.querySelector("input[name=dt]:checked").value;
  const notes    = document.getElementById("notes").value;

  const fd = new FormData();
  fd.append("doc_id", DOC_ID);
  fd.append("doc_type", doc_type);
  fd.append("notes", notes);

  await fetch("/upload/metadata", {method:"POST", headers: headers(), body: fd});
  document.getElementById("metaStatus").textContent = "✔️ saved";
}

// ─────────────── Q&A ROUTE ───────────────
async function ask () {
  if (!q.value.trim()) return;
  askBtn.disabled = true;
  answer.textContent = "Thinking…";

  const fd = new FormData();
  fd.append("question", q.value);

  try {
    const js = await fetch("/chat", {method:"POST", headers: headers(), body: fd}).then(r=>r.json());

    lastQuestion = q.value;
    lastAnswer   = js.answer;
    lastChunks   = js.chunks_used ?? js.chunks ?? [];

    if (js.grounded === false) {
      answer.innerHTML = `<i>${js.answer}</i><br><small>⚠︎ Not from manual</small>`;
    } else {
      answer.textContent = js.answer;
    }

    fb.classList.remove("hide");
  } catch (err) {
    answer.textContent = "❌ Request failed.";
    alert("Question failed: " + err);
  } finally {
    askBtn.disabled = false;
    answer.scrollIntoView({ behavior: "smooth" });
  }
}

// ─────────────── FEEDBACK ───────────────
async function sendFeedback (score) {
  const r = await fetch("/feedback", {
    method : "POST",
    headers: { ...headers(), "Content-Type": "application/json" },
    body   : JSON.stringify({
      customer   : "demo01",
      question   : lastQuestion,
      answer     : lastAnswer,
      score      : score,
      chunks_used: lastChunks
    })
  });
  const js = await r.json();
  if (js.ok) {
    fb.classList.add("hide");
    alert("Thanks for the feedback!");
  } else {
    alert("Feedback failed: " + JSON.stringify(js));
  }
}
</script>
</body>
</html>
