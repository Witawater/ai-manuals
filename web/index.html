<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI-Manuals demo</title>
  <style>
    body   {font-family:sans-serif;max-width:680px;margin:auto;padding:20px}
    #answer{white-space:pre-wrap;border:1px solid #ccc;padding:12px}
    .fb    {font-size:20px;margin:0 6px;cursor:pointer}
    .hide  {display:none}
  </style>
  <meta name="api-key" content="d4d6aa9f2bf75faf76454d8621af7c01">
</head>
<body>
<h2>Manual helper</h2>

<h4>Upload a PDF</h4>
<input type="file" id="pdf" />
<button onclick="upload()">Upload</button><br /><br />

<h4>Ask a question</h4>
<input id="q" size="60" placeholder="Type your question‚Ä¶" />
<button onclick="ask()">Ask</button><br /><br />

<div id="answer"></div>

<!-- feedback bar -->
<div id="fb" class="hide">
  <span class="fb" onclick="sendFeedback( 1)">üëç</span>
  <span class="fb" onclick="sendFeedback(-1)">üëé</span>
</div>

<p>
  <a href="/dashboard.html" target="_blank">üìä Feedback dashboard</a>
</p>


<script>
// This is a demo API key. For production, override via <meta name="api-key"> in the HTML <head>.
// Load API key from meta tag if available (fallback to hardcoded for demo)
const API_KEY = document.querySelector('meta[name="api-key"]')?.content || "d4d6aa9f2bf75faf76454d8621af7c01";

/* helper */
function authHeaders(extra = {}) {
  return { "X-API-Key": API_KEY, ...extra };
}
let lastQuestion = "", lastAnswer = "", lastChunks = [];

/* ========== upload PDF ========== */
async function upload () {
  if (!pdf.files[0]) return alert("Choose a PDF first!");
  const fd = new FormData();
  fd.append("file", pdf.files[0]);

  const r  = await fetch("/upload", {
    method : "POST",
    headers: authHeaders(),
    body   : fd
  });
  const js = await r.json();
  alert("Uploaded ‚Äú" + js.file + "‚Äù ‚Äì ready to ask questions!");
}

/* ========== ask a question ========== */
async function ask () {
  if (!q.value.trim()) return;

  const fd = new FormData();
  fd.append("question", q.value);

  const r  = await fetch("/chat", {
    method : "POST",
    headers: authHeaders(),
    body   : fd
  });
  const js = await r.json();

  lastQuestion = q.value;
  lastAnswer   = js.answer;
  lastChunks   = js.chunks_used ?? js.chunks ?? [];

  if (js.grounded === false) {
    answer.innerHTML =
      `<i>${js.answer}</i><br><small>‚ö†Ô∏é Not from manual</small>`;
  } else {
    answer.textContent = js.answer;
  }

  fb.classList.remove("hide");
}

/* ========== send thumbs ========== */
async function sendFeedback (score) {
  const r = await fetch("/feedback", {
    method : "POST",
    headers: {
      ...authHeaders(),
      "Content-Type": "application/json"
    },
    body   : JSON.stringify({
      customer   : "demo01",
      question   : lastQuestion,
      answer     : lastAnswer,
      score      : score,
      chunks_used: lastChunks             // server expects this field name
    })
  });
  const js = await r.json();
  if (js.ok) {
    fb.classList.add("hide");
    alert("Thanks for the feedback!");
  } else {
    alert("Feedback failed: " + JSON.stringify(js));
  }
}
</script>
</body>
</html>
