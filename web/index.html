<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI-Manuals demo</title>
  <style>
    body   {font-family:sans-serif;max-width:680px;margin:auto;padding:20px}
    #answer{white-space:pre-wrap;border:1px solid #ccc;padding:12px;margin-top:12px}
    .fb    {font-size:20px;margin:0 6px;cursor:pointer}
    .hide  {display:none}
    #status{margin-top:10px;font-size:14px;color:#555}
  </style>
  <meta name="api-key" content="d4d6aa9f2bf75faf76454d8621af7c01">
</head>
<body>
<h2>Manual helper</h2>

<h4>Upload a PDF</h4>
<input type="file" id="pdf" />
<button onclick="upload()">Upload</button>
<div id="status"></div>

<h4>Ask a question</h4>
<input id="q" size="60" placeholder="Type your question‚Ä¶" disabled />
<button onclick="ask()" id="askBtn" disabled>Ask</button><br /><br />

<div id="answer"></div>

<!-- feedback bar -->
<div id="fb" class="hide">
  <span class="fb" onclick="sendFeedback( 1)">üëç</span>
  <span class="fb" onclick="sendFeedback(-1)">üëé</span>
</div>

<p>
  <a href="/dashboard.html" target="_blank">üìä Feedback dashboard</a>
</p>

<script>
const API_KEY = document.querySelector('meta[name="api-key"]')?.content || "d4d6aa9f2bf75faf76454d8621af7c01";

function authHeaders(extra = {}) {
  return { "X-API-Key": API_KEY, ...extra };
}

let lastQuestion = "", lastAnswer = "", lastChunks = [];

async function upload () {
  const file = pdf.files[0];
  if (!file) return alert("Choose a PDF first!");
  if (!file.name.toLowerCase().endsWith(".pdf")) return alert("Please upload a valid PDF file.");

  q.disabled = true;
  askBtn.disabled = true;
  status.textContent = "Uploading and ingesting‚Ä¶ please wait.";

  const fd = new FormData();
  fd.append("file", file);

  try {
    const r  = await fetch("/upload", {
      method : "POST",
      headers: authHeaders(),
      body   : fd
    });
    const js = await r.json();
    status.textContent = `Uploaded ‚Äú${js.file}‚Äù ‚Äì ready to ask questions.`;
    q.disabled = false;
    askBtn.disabled = false;
  } catch (err) {
    status.textContent = "‚ùå Upload failed.";
    alert("Upload failed: " + err);
  }
}

async function ask () {
  if (!q.value.trim()) return;
  askBtn.disabled = true;
  answer.textContent = "Thinking‚Ä¶";

  const fd = new FormData();
  fd.append("question", q.value);

  try {
    const r  = await fetch("/chat", {
      method : "POST",
      headers: authHeaders(),
      body   : fd
    });
    const js = await r.json();

    lastQuestion = q.value;
    lastAnswer   = js.answer;
    lastChunks   = js.chunks_used ?? js.chunks ?? [];

    if (js.grounded === false) {
      answer.innerHTML =
        `<i>${js.answer}</i><br><small>‚ö†Ô∏é Not from manual</small>`;
    } else {
      answer.textContent = js.answer;
    }

    fb.classList.remove("hide");
  } catch (err) {
    answer.textContent = "‚ùå Request failed.";
    alert("Question failed: " + err);
  } finally {
    askBtn.disabled = false;
    answer.scrollIntoView({ behavior: "smooth" });
  }
}

async function sendFeedback (score) {
  const r = await fetch("/feedback", {
    method : "POST",
    headers: {
      ...authHeaders(),
      "Content-Type": "application/json"
    },
    body   : JSON.stringify({
      customer   : "demo01",
      question   : lastQuestion,
      answer     : lastAnswer,
      score      : score,
      chunks_used: lastChunks
    })
  });
  const js = await r.json();
  if (js.ok) {
    fb.classList.add("hide");
    alert("Thanks for the feedback!");
  } else {
    alert("Feedback failed: " + JSON.stringify(js));
  }
}
</script>
</body>
</html>
