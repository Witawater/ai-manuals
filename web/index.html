<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AIâ€‘Manuals demo</title>
  <style>
    body {font-family:sans-serif;max-width:680px;margin:auto;padding:20px}
    #answer{white-space:pre-wrap;border:1px solid #ccc;padding:12px;margin-top:12px}
    .fb {font-size:20px;margin:0 6px;cursor:pointer}
    .hide{display:none}
    #status{margin-top:10px;font-size:14px;color:#555}
  </style>
  <!-- FIXME: inject your real API key value below or via build-step -->
  <meta name="api-key" content="d4d6aa9f2bf75faf76454d8621af7c01">
</head>
<body>
  <h2>Manual helper</h2>

  <h4>Upload a PDF</h4>
  <input type="file" id="pdf" />
  <button onclick="upload()">Upload</button>
  <div id="status"></div>

  <h4>Ask a question</h4>
  <input id="q" size="60" placeholder="Type your questionâ€¦" disabled />
  <button onclick="ask()" id="askBtn" disabled>Ask</button><br><br>

  <div id="answer"></div>

  <!-- feedback bar (unchanged) -->
  <div id="fb" class="hide">
    <span class="fb" onclick="sendFeedback(1)">ğŸ‘</span>
    <span class="fb" onclick="sendFeedback(-1)">ğŸ‘</span>
  </div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DOM refs
const pdf      = document.getElementById('pdf');
const q        = document.getElementById('q');
const askBtn   = document.getElementById('askBtn');
const statusEl = document.getElementById('status');
const answerEl = document.getElementById('answer');

// API key â†’ headers
const API_KEY = document.querySelector('meta[name="api-key"]').content || "";
const headers = extra => ({ 'X-API-Key': API_KEY, ...extra });

let DOC_ID = "", pollTimer;
let uploading = false;                // NEW guard against duplicates

// â”€â”€â”€ Upload + ingest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function upload(){
  if(uploading) return;               // NEW: ignore extra clicks
  const file = pdf.files[0];
  if(!file){ alert('Pick a PDF first'); return; }

  uploading = true;                   // NEW
  statusEl.textContent = 'Uploadingâ€¦';
  q.disabled = askBtn.disabled = true;

  try {
    const fd = new FormData(); fd.append('file', file);
    const res = await fetch('/upload', { method:'POST', headers: headers(), body: fd });
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const js = await res.json();

    DOC_ID = js.doc_id;
    statusEl.textContent = 'Processing PDFâ€¦ fill the form meanwhile.';
    showMetaForm();                   // inserts only once now
    pollTimer = setInterval(checkReady, 2000);
  } catch(err){
    uploading = false;                // NEW
    statusEl.textContent = 'âŒ Upload failed.';
    alert('Upload failed: '+ err);
  }
}

async function checkReady(){
  try{
    const res = await fetch(`/ingest/status?doc_id=${DOC_ID}`, { headers: headers() });
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const job = await res.json();

    statusEl.textContent = `Embedded ${job.done}/${job.total} chunksâ€¦`;
    if(job.ready){
      clearInterval(pollTimer);
      uploading = false;             // NEW: allow new uploads after done
      statusEl.textContent = 'âœ… Ready â€“ ask away!';
      q.disabled = askBtn.disabled = false;
    }
  }catch(err){
    clearInterval(pollTimer);
    uploading = false;               // NEW
    statusEl.textContent = 'âŒ Status check failed.';
    alert('Status check failed: '+ err);
  }
}

// â”€â”€â”€ Metadata form (one-shot) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMetaForm(){
  if(document.getElementById('metaForm')) return;   // NEW: already shown
  const html = `
    <div id="metaForm">
      <hr><b>What type of manual?</b><br>
      <label><input type=radio name=dt value=software checked> Software</label>
      <label><input type=radio name=dt value=hardware> Physical product</label>
      <label><input type=radio name=dt value=service> Service</label><br>
      Notes: <input id=notes size=40 placeholder="e.g. 3-axis CNC mill">
      <button onclick="saveMeta()">Save</button> <span id="metaStatus"></span>
    </div>`;
  statusEl.insertAdjacentHTML('afterend', html);
}

async function saveMeta(){
  const doc_type = document.querySelector('input[name=dt]:checked').value;
  const notes = document.getElementById('notes').value;
  const fd = new FormData();
  fd.append('doc_id', DOC_ID);
  fd.append('doc_type', doc_type);
  fd.append('notes', notes);

  try{
    const res = await fetch('/upload/metadata', { method:'POST', headers: headers(), body: fd });
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    document.getElementById('metaStatus').textContent = 'âœ”ï¸ saved';
  }catch(err){
    alert('Metadata save failed: '+ err);
  }
}

// â”€â”€â”€ Ask â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function ask(){
  if(!q.value.trim()) return;
  askBtn.disabled = true; answerEl.textContent = 'Thinkingâ€¦';

  const fd = new FormData(); fd.append('question', q.value);
  try{
    const res = await fetch('/chat', { method:'POST', headers: headers(), body: fd });
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const js = await res.json();
    answerEl.textContent = js.answer;
  }catch(err){
    answerEl.textContent = 'âŒ Request failed.';
    alert('Question failed: '+ err);
  }finally{
    askBtn.disabled = false;
  }
}
</script>
</body>
</html>
